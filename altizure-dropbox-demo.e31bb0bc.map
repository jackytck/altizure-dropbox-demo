{"version":3,"sources":["config.js","helper.js","altizure.js","dropbox.js","index.js"],"names":["ALTI_KEY","ALTI_CALLBACK","randomState","length","text","possible","i","charAt","Math","floor","random","setCookie","name","value","days","expires","date","Date","setTime","getTime","toUTCString","document","cookie","getCookie","parts","split","pop","shift","deleteCookie","tokenStateFromHash","token","state","hash","window","location","re","mat","exec","ALTI_TOKEN","selectedFiles","onLogout","href","onUpload","pid","getElementById","alert","forEach","f","uploadSingle","url","link","query","gql","then","res","console","log","data","updateImageList","setInterval","headers","Headers","body","JSON","stringify","init","method","request","Request","fetch","response","json","renderUpload","divId","u","URL","searchParams","get","user","my","self","html","innerHTML","imgs","project","allImages","edges","map","x","node","onSuccess","files","fileNames","push","join","render","setupDropbox","tokenCookie","prevState","origin","pathname","authUrl","options","success","linkType","multiselect","extensions","folderselect","button","Dropbox","createChooseButton","appendChild","global"],"mappings":"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","file":"altizure-dropbox-demo.e31bb0bc.map","sourceRoot":"..","sourcesContent":["export const ALTI_KEY = '7MkQf8UggsPaadvrlKALspJWZejZAJOLHn3cnIy'\nexport const ALTI_CALLBACK = 'https://jackytck.github.io/altizure-dropbox-demo/index.html'\n","function randomState (length) {\n  let text = ''\n  const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'\n  for (let i = 0; i < length; i++) {\n    text += possible.charAt(Math.floor(Math.random() * possible.length))\n  }\n  return text\n}\n\nfunction setCookie (name, value, days) {\n  let expires = ''\n  if (days) {\n    const date = new Date()\n    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000))\n    expires = '; expires=' + date.toUTCString()\n  }\n  document.cookie = name + '=' + value + expires + ';path=/;secure'\n}\n\nfunction getCookie (name) {\n  const value = '; ' + document.cookie\n  const parts = value.split('; ' + name + '=')\n  if (parts.length === 2) {\n    return parts.pop().split(';').shift()\n  }\n}\n\nfunction deleteCookie (name) {\n  document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:01 GMT; path=/'\n}\n\nfunction tokenStateFromHash () {\n  let token = ''\n  let state = ''\n  const hash = window.location.hash\n  const re = /access_token=(\\w+).*state=(\\w+)/g\n  const mat = re.exec(hash)\n  if (mat && mat[1] && mat[2]) {\n    token = mat[1]\n    state = mat[2]\n  }\n  return { token, state }\n}\n\nexport {\n  randomState,\n  setCookie,\n  getCookie,\n  deleteCookie,\n  tokenStateFromHash\n}\n","import {\n  ALTI_CALLBACK,\n  ALTI_KEY\n} from './config'\nimport {\n  deleteCookie,\n  getCookie,\n  randomState,\n  setCookie,\n  tokenStateFromHash\n} from './helper'\n\nlet ALTI_TOKEN = ''\nlet selectedFiles = []\n\nfunction onLogout () {\n  deleteCookie('token')\n  window.location.href = ALTI_CALLBACK\n}\n\nfunction onUpload () {\n  const pid = document.getElementById('pid').value\n  if (!pid) {\n    alert('Enter pid!')\n    return\n  }\n  if (!selectedFiles.length) {\n    alert('No file is selected!')\n  }\n  selectedFiles.forEach(f => {\n    uploadSingle(({\n      pid,\n      name: f.name,\n      url: f.link\n    }))\n  })\n}\n\nfunction uploadSingle ({ pid, name, url }) {\n  const query = `\n    mutation {\n      uploadImageURL(pid: \"${pid}\", url: \"${url}\", filename: \"${name}\") {\n        id\n      }\n    }\n  `\n  gql({ query, token: ALTI_TOKEN }).then(res => {\n    console.log(res.data)\n    updateImageList()\n  })\n  setInterval(updateImageList, 5000)\n}\n\nfunction gql ({ query, token }) {\n  const headers = new Headers({\n    'Content-Type': 'application/json',\n    'key': ALTI_KEY,\n    'altitoken': token\n  })\n  const body = JSON.stringify({\n    query\n  })\n  const init = {\n    method: 'POST',\n    headers,\n    body\n  }\n  const request = new Request('https://api.altizure.com/graphql', init)\n  return fetch(request).then(function (response) {\n    return response.json()\n  })\n}\n\nfunction renderUpload (divId, token) {\n  const u = new URL(window.location.href)\n  const pid = u.searchParams.get('pid')\n  const query = `\n  {\n    my {\n      self {\n        name\n      }\n    }\n  }\n  `\n  gql({ query, token }).then(res => {\n    const user = res.data.my.self.name\n    const html = `\n            <h3>Welcome ${user}!</h3>\n            <p>1. Press Choose from Dropbox</p>\n            <p>2. Enter pid</p>\n            <p>3. Press Upload</p>\n            <input type=\"text\" id=\"pid\" name=\"pid\" placeholder=\"pid\" value=\"${pid}\" />\n            <button onclick=\"onUpload()\">Upload</button>\n            <div><div id=\"file-list\" /></div>\n            <div><div id=\"image-list\" /></div>\n            <br/>\n            <br/>\n            <button onclick=\"onLogout()\">Logout</button>\n          `\n    document.getElementById(divId).innerHTML = html\n  })\n}\n\nfunction updateImageList () {\n  const pid = document.getElementById('pid').value\n  const query = `\n  {\n  \tproject(id: \"${pid}\") {\n      allImages {\n        totalCount\n        edges {\n          node {\n            id\n            state\n            name\n            filename\n          }\n        }\n      }\n    }\n  }\n  `\n  gql({ query, token: ALTI_TOKEN }).then(res => {\n    const imgs = res.data.project.allImages.edges.map(x => `<li>${x.node.name}: ${x.node.state}</li>`)\n    document.getElementById('image-list').innerHTML = `<p>Project images:</p><ol>${imgs}</ol>`\n  })\n}\n\nfunction onSuccess (files) {\n  selectedFiles = []\n  const fileNames = []\n  for (let i = 0; i < files.length; i++) {\n    fileNames.push(`<li>${files[i].name}</li>`)\n    selectedFiles.push(files[i])\n  }\n  document.getElementById('file-list').innerHTML = `<p>Selected files:</p><ol>${fileNames.join('')}</ol>`\n}\n\nfunction render (divId, setupDropbox) {\n  const tokenCookie = getCookie('token')\n  if (!tokenCookie) {\n  // not login\n    const { token, state } = tokenStateFromHash()\n    if (token && state) {\n    // callback\n      const prevState = getCookie('state')\n      if (state !== prevState) {\n        document.getElementById(divId).innerHTML = '<h1>Invalid state!</h1>'\n      } else {\n        setCookie('token', token, 90)\n        deleteCookie('state')\n        ALTI_TOKEN = tokenCookie\n        window.location = `${window.location.origin}/${window.location.pathname}`\n        renderUpload(divId, token)\n        setupDropbox()\n      }\n    } else {\n    // render auth button\n      const state = randomState(20)\n      setCookie('state', state)\n      const authUrl = `https://api.altizure.com/auth/start?client_id=${ALTI_KEY}&response_type=token&redirect_uri=${ALTI_CALLBACK}&state=${state}`\n      document.getElementById(divId).innerHTML = `\n            <h1>Altizure Dropbox Demo</h1>\n            <button type='reset' onclick=\"location.href='${authUrl}'\">\n              Login with Altizure account\n            </button>\n          `\n    }\n  } else {\n    ALTI_TOKEN = tokenCookie\n    renderUpload(divId, tokenCookie)\n    setupDropbox()\n  }\n}\n\nexport {\n  onLogout,\n  onUpload,\n  onSuccess,\n  render\n}\n","/* global Dropbox */\nfunction setupDropbox (divId, onSuccess) {\n  return function () {\n    const options = {\n      success: onSuccess,\n      linkType: 'direct',\n      multiselect: true,\n      extensions: ['images'],\n      folderselect: false\n    }\n    const button = Dropbox.createChooseButton(options)\n    document.getElementById(divId).appendChild(button)\n  }\n}\n\nexport default setupDropbox\n","import {\n  onLogout,\n  onSuccess,\n  onUpload,\n  render\n} from './altizure'\n\nimport setupDropbox from './dropbox'\n\nglobal.onUpload = onUpload\nglobal.onLogout = onLogout\n\nrender('altizure-container', setupDropbox('dropbox-container', onSuccess))\n"]}