{"version":3,"sources":["config.js","helper.js","altizure.js","dropbox.js","index.js"],"names":["ALTI_KEY","ALTI_CALLBACK","randomState","length","text","possible","i","charAt","Math","floor","random","setCookie","name","value","days","expires","date","Date","setTime","getTime","toUTCString","document","cookie","getCookie","parts","split","pop","shift","deleteCookie","tokenStateFromHash","token","state","hash","window","location","mat","exec","ALTI_TOKEN","selectedFiles","onLogout","href","onUpload","pid","getElementById","alert","forEach","f","uploadSingle","url","link","gql","query","then","res","console","log","data","updateImageList","setInterval","headers","Headers","body","JSON","stringify","request","Request","method","fetch","response","json","renderUpload","divId","user","my","self","html","innerHTML","imgs","project","allImages","edges","map","x","node","onSuccess","files","fileNames","push","join","render","setupDropbox","tokenCookie","origin","pathname","authUrl","options","success","linkType","multiselect","extensions","folderselect","button","Dropbox","createChooseButton","appendChild","global"],"mappings":"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","file":"altizure-dropbox-demo.8958fdcb.map","sourceRoot":"..","sourcesContent":["export const ALTI_KEY = '7MkQf8UggsPaadvrlKALspJWZejZAJOLHn3cnIy'\nexport const ALTI_CALLBACK = 'https://jackytck.github.io/altizure-dropbox-demo/index.html'\n","function randomState (length) {\n  let text = ''\n  const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'\n  for (let i = 0; i < length; i++) {\n    text += possible.charAt(Math.floor(Math.random() * possible.length))\n  }\n  return text\n}\n\nfunction setCookie (name, value, days) {\n  let expires = ''\n  if (days) {\n    const date = new Date()\n    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000))\n    expires = '; expires=' + date.toUTCString()\n  }\n  document.cookie = name + '=' + value + expires + ';path=/;secure'\n}\n\nfunction getCookie (name) {\n  const value = '; ' + document.cookie\n  const parts = value.split('; ' + name + '=')\n  if (parts.length === 2) {\n    return parts.pop().split(';').shift()\n  }\n}\n\nfunction deleteCookie (name) {\n  document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:01 GMT; path=/'\n}\n\nfunction tokenStateFromHash () {\n  let token = ''\n  let state = ''\n  const hash = window.location.hash\n  const re = /access_token=(\\w+).*state=(\\w+)/g\n  const mat = re.exec(hash)\n  if (mat && mat[1] && mat[2]) {\n    token = mat[1]\n    state = mat[2]\n  }\n  return { token, state }\n}\n\nexport {\n  randomState,\n  setCookie,\n  getCookie,\n  deleteCookie,\n  tokenStateFromHash\n}\n","import {\n  ALTI_CALLBACK,\n  ALTI_KEY\n} from './config'\nimport {\n  deleteCookie,\n  getCookie,\n  randomState,\n  setCookie,\n  tokenStateFromHash\n} from './helper'\n\nlet ALTI_TOKEN = ''\nlet selectedFiles = []\n\nfunction onLogout () {\n  deleteCookie('token')\n  window.location.href = ALTI_CALLBACK\n}\n\nfunction onUpload () {\n  const pid = document.getElementById('pid').value\n  if (!pid) {\n    alert('Enter pid!')\n    return\n  }\n  if (!selectedFiles.length) {\n    alert('No file is selected!')\n  }\n  selectedFiles.forEach(f => {\n    uploadSingle(({\n      pid,\n      name: f.name,\n      url: f.link\n    }))\n  })\n}\n\nfunction uploadSingle ({ pid, name, url }) {\n  const query = `\n    mutation {\n      uploadImageURL(pid: \"${pid}\", url: \"${url}\", filename: \"${name}\") {\n        id\n      }\n    }\n  `\n  gql({ query, token: ALTI_TOKEN }).then(res => {\n    console.log(res.data)\n    updateImageList()\n  })\n  setInterval(updateImageList, 5000)\n}\n\nfunction gql ({ query, token }) {\n  const headers = new Headers({\n    'Content-Type': 'application/json',\n    'key': ALTI_KEY,\n    'altitoken': token\n  })\n  const body = JSON.stringify({\n    query\n  })\n  const init = {\n    method: 'POST',\n    headers,\n    body\n  }\n  const request = new Request('https://api.altizure.com/graphql', init)\n  return fetch(request).then(function (response) {\n    return response.json()\n  })\n}\n\nfunction renderUpload (divId, token) {\n  const query = `\n  {\n    my {\n      self {\n        name\n      }\n    }\n  }\n  `\n  gql({ query, token }).then(res => {\n    const user = res.data.my.self.name\n    const html = `\n            <h3>Welcome ${user}!</h3>\n            <p>1. Press Choose from Dropbox</p>\n            <p>2. Enter pid</p>\n            <p>3. Press Upload</p>\n            <input type=\"text\" id=\"pid\" name=\"pid\" placeholder=\"pid\" />\n            <button onclick=\"onUpload()\">Upload</button>\n            <div><div id=\"file-list\" /></div>\n            <div><div id=\"image-list\" /></div>\n            <br/>\n            <br/>\n            <button onclick=\"onLogout()\">Logout</button>\n          `\n    document.getElementById(divId).innerHTML = html\n  })\n}\n\nfunction updateImageList () {\n  const pid = document.getElementById('pid').value\n  const query = `\n  {\n  \tproject(id: \"${pid}\") {\n      allImages {\n        totalCount\n        edges {\n          node {\n            id\n            state\n            name\n            filename\n          }\n        }\n      }\n    }\n  }\n  `\n  gql({ query, token: ALTI_TOKEN }).then(res => {\n    const imgs = res.data.project.allImages.edges.map(x => `<li>${x.node.name}: ${x.node.state}</li>`)\n    document.getElementById('image-list').innerHTML = `<p>Project images:</p><ol>${imgs}</ol>`\n  })\n}\n\nfunction onSuccess (files) {\n  selectedFiles = []\n  const fileNames = []\n  for (let i = 0; i < files.length; i++) {\n    fileNames.push(`<li>${files[i].name}</li>`)\n    selectedFiles.push(files[i])\n  }\n  document.getElementById('file-list').innerHTML = `<p>Selected files:</p><ol>${fileNames.join('')}</ol>`\n}\n\nfunction render (divId, setupDropbox) {\n  const tokenCookie = getCookie('token')\n  if (!tokenCookie) {\n  // not login\n    const { token, state } = tokenStateFromHash()\n    if (token && state) {\n    // callback\n      const prevState = getCookie('state')\n      if (state !== prevState) {\n        document.getElementById(divId).innerHTML = '<h1>Invalid state!</h1>'\n      } else {\n        setCookie('token', token, 90)\n        deleteCookie('state')\n        ALTI_TOKEN = tokenCookie\n        window.location = `${window.location.origin}/${window.location.pathname}`\n        renderUpload(divId, token)\n        setupDropbox()\n      }\n    } else {\n    // render auth button\n      const state = randomState(20)\n      setCookie('state', state)\n      const authUrl = `https://api.altizure.com/auth/start?client_id=${ALTI_KEY}&response_type=token&redirect_uri=${ALTI_CALLBACK}&state=${state}`\n      document.getElementById(divId).innerHTML = `\n            <h1>Altizure Dropbox Demo</h1>\n            <button type='reset' onclick=\"location.href='${authUrl}'\">\n              Login with Altizure account\n            </button>\n          `\n    }\n  } else {\n    ALTI_TOKEN = tokenCookie\n    renderUpload(divId, tokenCookie)\n    setupDropbox()\n  }\n}\n\nexport {\n  onLogout,\n  onUpload,\n  onSuccess,\n  render\n}\n","/* global Dropbox */\nfunction setupDropbox (divId, onSuccess) {\n  return function () {\n    const options = {\n      success: onSuccess,\n      linkType: 'direct',\n      multiselect: true,\n      extensions: ['images'],\n      folderselect: false\n    }\n    const button = Dropbox.createChooseButton(options)\n    document.getElementById(divId).appendChild(button)\n  }\n}\n\nexport default setupDropbox\n","import {\n  onLogout,\n  onSuccess,\n  onUpload,\n  render\n} from './altizure'\n\nimport setupDropbox from './dropbox'\n\nglobal.onUpload = onUpload\nglobal.onLogout = onLogout\n\nrender('altizure-container', setupDropbox('dropbox-container', onSuccess))\n"]}